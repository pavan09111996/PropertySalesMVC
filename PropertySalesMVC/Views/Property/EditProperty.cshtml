@model EditPropertyViewModel
@{
    ViewData["Title"] = "Edit Property";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<link href="~/css/property-update.css" rel="stylesheet" />

<div class="edit-property-container">
    <h2>Edit Property</h2>
    <p class="edit-subtitle">Update property details and manage images</p>

    <form asp-action="EditProperty"
          asp-controller="Property"
          method="post"
          enctype="multipart/form-data">

        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="PropertyId" />

        <hr class="form-divider">

        <div class="mb-3">
            <label>Title</label>
            <input asp-for="Title" class="form-control" />
        </div>

        <div class="mb-3">
            <label>Location</label>
            <input asp-for="Location" class="form-control" />
        </div>

        <div class="mb-3">
            <label>Price</label>
            <input asp-for="Price" class="form-control" />
        </div>

        <div class="mb-3">
            <label>Description</label>
            <textarea asp-for="Description" class="form-control" rows="4"></textarea>
        </div>

        <hr class="form-divider">

        <!-- IMAGE GRID (ONE GRID ONLY) -->
        <label class="fw-bold">Property Images</label>

        <div id="imageGrid" class="image-grid">
            @foreach (var img in Model.ExistingImages)
            {
                <div class="image-card existing">
                    <img src="data:image/jpeg;base64,@img.ImageBase64" />

                    <button type="button"
                            class="remove-btn"
                            onclick="markExistingImageForRemoval(this)">
                        ×
                    </button>

                    <input type="hidden"
                           name="RemoveImageIds"
                           value="@img.ImageId"
                           disabled />
                </div>
            }
        </div>

        <!-- NEW IMAGES INPUT -->
        <input type="file"
               id="newImagesInput"
               name="NewImages"
               class="form-control mt-3"
               multiple
               accept="image/*" />

        <button class="btn-save mt-4">Update Property</button>
        <a class="btn-cancel">Cancel</a>
    </form>
</div>


<script>
    const newImagesInput = document.getElementById("newImagesInput");
    const imageGrid = document.getElementById("imageGrid");

    let newFiles = [];

    newImagesInput.addEventListener("change", function () {
        Array.from(this.files).forEach(file => {
            if (!file.type.startsWith("image/")) return;

            newFiles.push(file);
            renderNewImage(file, newFiles.length - 1);
        });

        syncNewFiles();
    });

    function renderNewImage(file, index) {
        const reader = new FileReader();

        reader.onload = e => {
            const card = document.createElement("div");
            card.className = "image-card new";

            card.innerHTML = `
                <img src="${e.target.result}">
                <button type="button" class="remove-btn" onclick="removeNewImage(${index})">×</button>
            `;

            imageGrid.appendChild(card);
        };

        reader.readAsDataURL(file);
    }

    function removeNewImage(index) {
        newFiles.splice(index, 1);
        rebuildGrid();
        syncNewFiles();
    }

    function rebuildGrid() {
        // Remove only NEW images
        document.querySelectorAll(".image-card.new").forEach(e => e.remove());

        newFiles.forEach((file, i) => renderNewImage(file, i));
    }

    function syncNewFiles() {
        const dt = new DataTransfer();
        newFiles.forEach(f => dt.items.add(f));
        newImagesInput.files = dt.files;
    }

    function markExistingImageForRemoval(btn) {
        const card = btn.closest(".image-card");
        card.classList.toggle("marked-for-delete");

        const hiddenInput = card.querySelector("input[type='hidden']");
        hiddenInput.disabled = !hiddenInput.disabled;
    }
</script>
